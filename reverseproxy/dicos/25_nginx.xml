<?xml version="1.0" encoding="utf-8"?>

<creole>
    <files>
        <service>nginx</service>
        <package>reverseproxy-pkg</package>
        <file name='/etc/nginx/sites-enabled/default' source='nginx.default'/>
        <file name='/var/www/nginx-default/nginx.html' source='nginx.html'/>
        <file name='/var/www/index.html' source='nginx.no_proxy.html'/>
        <file name="/var/www/wpad.eth1" mode='644'/>
        <file name="/var/www/wpad.eth2" mode='644'/>
        <file name="/var/www/wpad.eth3" mode='644'/>
        <file name="/var/www/wpad.eth4" mode='644'/>
        <file name="/usr/share/eole/firewall/00_root_reverseproxy.fw" />
        <!--<file name="/etc/squid/domaines_noauth_acad"/>
        <file name="/etc/squid/domaines_nocache_acad"/>
        <file name="/etc/nginx/sites-enabled/access_proxy"/>-->
    </files>

    <variables>
        <family name='services'>
            <variable name='activer_revprox' type='oui/non' description='Activer le reverse proxy Nginx'>
                <value>non</value>
            </variable>
            <!-- Use for dependency -->
            <variable name='activer_apache' type='oui/non' description='Activer le serveur web Apache' exists='False'>
              <value>non</value>
            </variable>
        </family>
        <family name='Reverse proxy' hidden='True'>
            <variable name='revprox_default' type="string" description="Nom de domaine par défaut" />
            <variable name='revprox_sso' type='string' description="Nom de domaine du serveur SSO" />
            <variable name='revprox_poshadmin' type='string' description="Nom de domaine du serveur d'administration Envole 2" />
            <variable name='revprox_ead' type='string' description="IP du Scribe" hidden='True' />
            <variable name='revprox_ead_port' type='number' description="Port d'accès à l'EAD du Scribe depuis l'extérieur" hidden='True'>
                <value>4203</value>
            </variable>
            <variable name='revprox_auto_config_local_web' type='oui/non' description='Activer la configuration automatique pour les applications locales'>
                <value>non</value>
            </variable>
            <variable name='revprox_activate_http' type='oui/non' description='Activer le reverse proxy Nginx pour http/https'>
                <value>non</value>
            </variable>
            <variable name='revprox_domainname' type='string' description="Nom de domaine à rediriger" multi='True' />
            <variable name='revprox_rep' type='string' description="Répertoire ou nom de la page à rediriger">
                <value>/</value>
            </variable>
            <variable name='revprox_http' type='string' description="Reverse proxy HTTP">
                <value>redirige vers https</value>
            </variable>
            <variable name='revprox_https' type='oui/non' description="Reverse proxy HTTPS">
                <value>oui</value>
            </variable>
            <variable name='revprox_url' type='string' description="IP ou domaine de destination (avec http:// ou https://) ou URI complète"/>
            <variable name="activer_revprox_rewrite" type="oui/non" description="Activer la réécriture d'URL" mode="expert">
                <value>non</value>
            </variable>
            <variable name="revprox_rewrite_domaine" type="string" description="Nom de domaine concerné par la réécriture" mode="expert" multi="True" />
            <variable name="revprox_rewrite_proto" type="string" description="Protocole" mode="expert">
                <value>http/https</value>
            </variable>
            <variable name='revprox_rewrite_location' type='string' description="Répertoire de la réécriture" mode="expert" />
            <variable name="revprox_rewrite_regex" type="string" description="Regex de la réécriture" mode="expert" />
            <variable name="revprox_rewrite_replacement" type="string" description="La valeur de remplacement" mode="expert" />
        </family>
        <family name='applications web' hidden='True'>
            <!-- creer si n'existe pas et cache-->
            <variable name='activer_web_behind_revproxy' type='oui/non' exists='False' hidden='True'>
                <value>oui</value>
            </variable>
            <variable name='web_behind_revproxy_ip' type='ip' exists='False' hidden='True'/>
        </family>
        <separators>
            <separator name='revprox_sso'>Redirection de services particuliers</separator>
            <separator name='revprox_activate_http'>Redirection HTTP et HTTPS</separator>
        </separators>
    </variables>
    <constraints>
    <!--************************************************************************************************* -->
    <!-- **** Listes deroulantes **** -->
        <check name='valid_enum' target='revprox_http'>
            <param>['oui','non', 'redirige vers https']</param>
        </check>
        <check name='valid_enum' target='revprox_rewrite_proto'>
            <param>['http/https','http', 'https']</param>
        </check>
        <!-- **** Remplissage automatique **** -->
        <auto target='revprox_ead' name='auto_copy_val'>
            <param type='eole'>revprox_poshadmin</param>
        </auto>
        <!-- **** Conditions **** -->
        <condition name='hidden_if_in' source='activer_revprox'>
            <param>non</param>
            <target type='family'>Reverse proxy</target>
        </condition>
        <condition name='hidden_if_in' source='activer_apache'>
            <param>non</param>
            <target type='variable'>revprox_auto_config_local_web</target>
        </condition>
        <condition name='hidden_if_in' source='activer_revprox_rewrite'>
            <param>non</param>
            <target type='variable'>revprox_rewrite_proto</target>
            <target type='variable'>revprox_rewrite_domaine</target>
            <target type='variable'>revprox_rewrite_location</target>
            <target type='variable'>revprox_rewrite_regex</target>
            <target type='variable'>revprox_rewrite_replacement</target>
        </condition>
    <!-- **** Groupes **** -->
        <group master='revprox_domainname'>
            <slave>revprox_rep</slave>
            <slave>revprox_url</slave>
            <slave>revprox_http</slave>
            <slave>revprox_https</slave>
        </group>
        <group master='revprox_rewrite_domaine'>
            <slave>revprox_rewrite_proto</slave>
            <slave>revprox_rewrite_location</slave>
            <slave>revprox_rewrite_regex</slave>
            <slave>revprox_rewrite_replacement</slave>
        </group>
        <check name='obligatoire' target='revprox_domainname'/>
        <check name='obligatoire' target='revprox_rep'/>
        <check name='obligatoire' target='revprox_http'/>
        <check name='obligatoire' target='revprox_https'/>
        <check name='obligatoire' target='revprox_url'/>
        <check name='obligatoire' target='revprox_rewrite_domaine'/>
        <check name='obligatoire' target='revprox_rewrite_location'/>
        <check name='obligatoire' target='revprox_rewrite_regex'/>
        <check name='obligatoire' target='revprox_rewrite_replacement'/>
        <condition name='hidden_if_in' source='revprox_activate_http'>
            <param>non</param>
            <target type='variable'>revprox_domainname</target>
            <target type='variable'>revprox_rep</target>
            <target type='variable'>revprox_http</target>
            <target type='variable'>revprox_https</target>
            <target type='variable'>revprox_url</target>
        </condition>
        <condition name='hidden_if_in' source='activer_web_behind_revproxy'>
            <param>non</param>
            <target type='variable'>web_behind_revproxy_ip</target>
        </condition>
        <auto name='calc_container' target='web_behind_revproxy_ip'>
            <param type='eole'>mode_conteneur_actif</param>
            <param type='container'>br0</param>
            <param type='eole' optional='True'>mode_zephir</param>
        </auto>
    </constraints>
    <!--************************************************************************************************* -->
    <help>
        <variable name='revprox_default'>Si un client accède au serveur avec un nom de domaine non déclaré, le flux est redirigé vers ce domaine</variable>
        <variable name='revprox_sso'>Pour rediriger vers le SSO de la machine "domainelocal", taper "domainelocal"</variable>
        <variable name='revprox_poshadmin'>Pour rediriger vers le POSHAdmin de la machine "domainelocal", taper "domainelocal"</variable>
        <variable name='revprox_auto_config_local_web'>Configure automatiquement le reverse proxy afin de faire pointer web_url sur le conteneur web</variable>
        <variable name='revprox_domainname'>Exemple pour rediriger "http://domaine/", taper "domaine"</variable>
        <variable name='revprox_rep'>URL relative (sans le nom de domaine) redirigé pour l'adresse définie dans la variable ci-dessus (exemple "/mail")</variable>
        <variable name='revprox_url'>Nom de domaine ou IP de destination, par exemple "http://domainelocal" ou URI, par exemple "http://domainelocal/dir/"</variable>
        <variable name='activer_revprox'>Le Reverse Proxy permet de relayer des accès extérieurs vers des serveurs situés derrière le pare-feu</variable>
    </help>
</creole>
<!-- vim: ts=4 sw=4 expandtab
-->
